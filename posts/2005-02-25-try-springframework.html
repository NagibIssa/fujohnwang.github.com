<!DOCTYPE html>
<html lang="zh">

  <head>
	  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
	  <title>闲话spring在系统实现中的应用</title>
	  <meta name="author" content="FuqiangWang">
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="favicon.ico">
        <meta name="date" content="2005-02-25" />
            <style type="text/css">
    table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
      margin: 0; padding: 0; vertical-align: baseline; border: none; }
    table.sourceCode { width: 100%; line-height: 100%; }
    td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
    td.sourceCode { padding-left: 5px; }
    code > span.kw { color: #007020; font-weight: bold; }
    code > span.dt { color: #902000; }
    code > span.dv { color: #40a070; }
    code > span.bn { color: #40a070; }
    code > span.fl { color: #40a070; }
    code > span.ch { color: #4070a0; }
    code > span.st { color: #4070a0; }
    code > span.co { color: #60a0b0; font-style: italic; }
    code > span.ot { color: #007020; }
    code > span.al { color: #ff0000; font-weight: bold; }
    code > span.fu { color: #06287e; }
    code > span.er { color: #ff0000; font-weight: bold; }
    </style>
                
    <link href='/font/Syncopate/stylesheet.css' rel='stylesheet' type='text/css'>
    <link href='/font/News_Cycle/stylesheet.css' rel='stylesheet' type='text/css'>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/bootstrap-theme.min.css" rel="stylesheet">
    <link href="/css/afoo.me.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-3 sidebar">
            <a href="/">
                <h2 class="text-center">AFOO.ME</h2>
            </a>
            <p class="text-center lead slogan"><a href="/slogan.html">lollapalooza &amp; positioning</a></p>

            <ul class="nav nav-pills nav-stacked">
              <li><a href="/favorite.html" class="text-center"><i class="icon-star-empty"></i> Favorite</a></li>
              <li><a href="/dashboard.html" class="text-center"><i class="icon-fullscreen"></i> Dashboard</a></li>
              <li><a href="shortcuts/shortcuts.html" class="text-center"><i class="icon-folder-close-alt"></i> Shortcuts</a></li>
              <li><a href="/feeds.xml" class="text-center"><i class="icon-folder-close-alt"></i> RSS</a></li>
              <li><a href="/whoami.html" class="text-center"><i class="icon-user-md"></i> About</a></li>
            </ul>

        </div>
        <div class="col-md-9 col-md-offset-3 main">
            <div class="row">
              <div class="container-fluid">
                
                <div class="row">
                                <div id="header">
                <p class="lead">
                <h1 class="title">闲话spring在系统实现中的应用&nbsp;&nbsp;
                <small>
                                    FuqiangWang
                                </small>
                </h1>
                </p>
                </div>
                                <div>

                <hr>

                                <blockquote>
<p>2014年从msn space存档中重新恢复出来！</p>
</blockquote>
<p>前阵子逮到一点儿时间，就零零散散地看了几章《Expert one on one J2EE design and development》，从Rod的所言所语深有感触。对于java应用的开发也就有了进一步的认识，尤其是持久层的一些理念，从而工作中也尽量应用这些理念以加深印象，提高软件开发效率和质量。</p>
<p>近几天在完成了credit的子工程MailMonitor之后，credit web方面又有一个要做job schedule的子项目，功能更先前的MailMonitor差不多，所以leader让我给这个子项目先搭建一个框架，以便web方面可以在这个框架下实现最终的功能。</p>
<p>鉴于前阵子一直在尝试将spring运用于项目的开发，所以这次也不例外，我又采用了spring，呵呵，谁让他让我来搭建这个框架那，:em221:，题外话，说是实在的，spring好用，这是勿庸置疑的，但是，配置文件嘛，就不是那么easy了，要协调和配置那么些业务对象，稍一不留神就会出错，虽然我现在用的业务对象 并不多，但是也明显感到配置这些业务对象的繁琐，不过，这边儿繁琐了，对于业务对象的实现却有很大的简化，尤其是spring对于持久层技术的支持，使你可以明显感觉到在使用了spring后，实现持久层逻辑的简单加快捷。所以说，还是老话题，在将metadata放在类文件中还是说写到配置文件中，这完全取决你，因为在这两种方式之间明显有一个权衡点，如何去找到你可以接收的权衡点，it‘s all up to you！</p>
<p>初步分析总体流程之后，我发现可以将其总结为简单的三步：</p>
<ol style="list-style-type: decimal">
<li>生成发送给B公司的csv文件；</li>
<li>对该csv数据文件进行pgp加密；</li>
<li>对加密完的csv文件进行压缩</li>
</ol>
<p>在完成了以上的工作之后，就可以将压缩文件作为附件attach到邮件之中并发送，整个流程也就这么简单。但是，简单归简单，我们依然可以做出简洁漂亮的设计并参照实现之。</p>
<p>其实，所有的工作无非就是要发送邮件，以上的三步最终都是为发送mail做准备，至于这三步到底如何实现，我们可以不去关心，我们所关注的只是发送mail，所以，首先我们要提出一个接口，标志我们的mail发送逻辑，姑且将该接口命名为ICSVMailSender，下面是其代码：</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">package com.livedoor.finance.credit.csvmail.bo;</span>

<span class="co">/**</span>
<span class="co"> * </span><span class="kw">@author </span><span class="co">Darren.Wang</span>
<span class="co"> * 2005-2-24 11:11:11</span>
<span class="co"> */</span>
<span class="kw">public</span> <span class="kw">interface</span> ICSVMailSender {
 <span class="dt">void</span> <span class="fu">sendCSV</span>();
}</code></pre>
<p>针对该接口，我们给出一个抽象的实现：</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">abstract</span> <span class="kw">class</span> AbstractCSVMailSender <span class="kw">implements</span> ICSVMailSender{
…….
<span class="kw">public</span> <span class="dt">final</span> <span class="dt">void</span> <span class="fu">sendCSV</span>() {
<span class="dv">1</span>. 生成csv文件
<span class="dv">2</span>. 对csv文件进行加密
<span class="dv">3</span>. 对加密后的csv文件进行压缩以便发送
<span class="dv">4</span>. 将加密后的csv以附件形式attach到mail中并发送
}
 <span class="co">/**</span>
<span class="co">  * Hook Method</span>
<span class="co">  * do db query and generate CSV file in this method</span>
<span class="co">  * </span><span class="kw">@return </span><span class="co">String csv data</span>
<span class="co">  */</span>
 <span class="kw">protected</span> <span class="kw">abstract</span> String <span class="fu">createCSV</span>();
 
 <span class="co">/**</span>
<span class="co">  * Hook Method</span>
<span class="co">  * do encription with original string type csv data,and return encripted data</span>
<span class="co">  * </span><span class="kw">@param originalStr</span>
<span class="co">  * </span><span class="kw">@return </span><span class="co">byte[],encripted data in byte[] array type</span>
<span class="co">  */</span>
 <span class="kw">protected</span> <span class="kw">abstract</span> <span class="dt">byte</span>[] <span class="fu">encryptCSV</span>(String originalStr);
 
 <span class="co">/**</span>
<span class="co">  * Hook Method</span>
<span class="co">  * zip the encripted csv data into a file, so that the mail can send it as an attachement</span>
<span class="co">  * </span><span class="kw">@param encryptedData</span>
<span class="co">  * </span><span class="kw">@return </span><span class="co">File, zipFile after zip</span>
<span class="co">  */</span>
 <span class="kw">protected</span> <span class="kw">abstract</span> File <span class="fu">zipCSV</span>(<span class="dt">byte</span>[] encryptedData);
}</code></pre>
<p>其实，对于明眼人来说，以上代码一出，则马上就会认出，呵呵，这不明显一个template模式的应用嘛，right，呵呵，就是它，在Rod的《Expert ….》一书中也着重提过该设计模式的应用，而且spring中应用该模式的例子也挺多，比如JdbcTemlate等，鉴于这次所要求的功能，我认为将template设计模式应用于此再合适不过了。在以上模板的基础上，我们可以自由实现以上三个抽象方法来提供最终的数据，你是用jdbc还是hibernate还是其他，我们不关心，这些自由选择的权利我们都下放给具体的实现者，这不是很好嘛！</p>
<p>有了以上的基础，我们的实现也变得很简单,只要继承类并实现三个方法所要实现的业务逻辑就可以了，比如：</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> CSVMailSenderImpl <span class="kw">extends</span> AbstractCSVMailSender
{
 <span class="co">/* (non-Javadoc)</span>
<span class="co">  * @see com.livedoor.finance.credit.csvmail.bo.AbstractCSVMailSender#createCSV()</span>
<span class="co">  */</span>
 <span class="kw">protected</span> String <span class="fu">createCSV</span>() {
 …
 }
 <span class="co">/* (non-Javadoc)</span>
<span class="co">  * @see com.livedoor.finance.credit.csvmail.bo.AbstractCSVMailSender#encryptCSV(java.lang.String)</span>
<span class="co">  */</span>
 <span class="kw">protected</span> <span class="dt">byte</span>[] <span class="fu">encryptCSV</span>(String originalStr) {
 …
 }
 <span class="co">/* (non-Javadoc)</span>
<span class="co">  * @see com.livedoor.finance.credit.csvmail.bo.AbstractCSVMailSender#zipCSV(byte[])</span>
<span class="co">  */</span>
 <span class="kw">protected</span> File <span class="fu">zipCSV</span>(<span class="dt">byte</span>[] encryptedData) {
 …
}
}</code></pre>
<p>这样，我们总的业务框架就完成了，在此基础上，我们要实现job schedule，而这在有了spring之后，变得是如此的简单，因为他对于quartz和timer都进行了有效的封装，我们只需要配置一下配置文件就可以全部搞定，而在具体的job实现类里面，我们只要实例化ICSVMailSender的某个具体实现类，并调用其sendCSV（）方法就可以了。是不是很便捷那？！</p>
<p>下面是spring-config.xml的部分片段，以供参考：</p>
<pre class="sourceCode xml"><code class="sourceCode xml"> ...
<span class="kw">&lt;bean</span><span class="ot"> name=</span><span class="st">&quot;mailJob&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.scheduling.quartz.JobDetailBean&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;property</span><span class="ot"> name=</span><span class="st">&quot;jobClass&quot;</span><span class="kw">&gt;</span>
   <span class="kw">&lt;value&gt;</span>com.livedoor.finance.credit.csvmail.job.CSVMailJob<span class="kw">&lt;/value&gt;</span>
  <span class="kw">&lt;/property&gt;</span>
  <span class="kw">&lt;property</span><span class="ot"> name=</span><span class="st">&quot;jobDataAsMap&quot;</span><span class="kw">&gt;</span>
   <span class="kw">&lt;map&gt;</span>
    <span class="kw">&lt;entry</span><span class="ot"> key=</span><span class="st">&quot;csvMailSender&quot;</span><span class="kw">&gt;</span>
     <span class="kw">&lt;ref</span><span class="ot"> bean=</span><span class="st">&quot;csvMailSender&quot;</span><span class="kw">/&gt;</span>
    <span class="kw">&lt;/entry&gt;</span>
   <span class="kw">&lt;/map&gt;</span>
  <span class="kw">&lt;/property&gt;</span>
 <span class="kw">&lt;/bean&gt;</span>
<span class="kw">&lt;bean</span><span class="ot"> id=</span><span class="st">&quot;cronTrigger&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.scheduling.quartz.CronTriggerBean&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;property</span><span class="ot"> name=</span><span class="st">&quot;jobDetail&quot;</span><span class="kw">&gt;</span>
   <span class="kw">&lt;ref</span><span class="ot"> bean=</span><span class="st">&quot;mailJob&quot;</span><span class="kw">/&gt;</span>
  <span class="kw">&lt;/property&gt;</span>
  <span class="kw">&lt;property</span><span class="ot"> name=</span><span class="st">&quot;cronExpression&quot;</span><span class="kw">&gt;</span>
   <span class="kw">&lt;value&gt;</span>0 0 3 * * ?<span class="kw">&lt;/value&gt;</span>
  <span class="kw">&lt;/property&gt;</span>
 <span class="kw">&lt;/bean&gt;</span>
 
<span class="kw">&lt;bean</span><span class="ot"> name=</span><span class="st">&quot;schedulerFactory&quot;</span><span class="ot"> class=</span><span class="st">&quot;org.springframework.scheduling.quartz.SchedulerFactoryBean&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;property</span><span class="ot"> name=</span><span class="st">&quot;triggers&quot;</span><span class="kw">&gt;</span>
   <span class="kw">&lt;list&gt;</span>
    <span class="kw">&lt;ref</span><span class="ot"> bean=</span><span class="st">&quot;cronTrigger&quot;</span><span class="kw">/&gt;</span>
   <span class="kw">&lt;/list&gt;</span>
  <span class="kw">&lt;/property&gt;</span>
 <span class="kw">&lt;/bean&gt;</span></code></pre>
<p>除了以上所述之外，还有一点可以值得一提的就是spring提供的邮件发送功能，我们既然要给b公司发送数据邮件，当然邮件的发送逻辑是不可少的啦，所以，在AbstractCSVMailSender模板类的sendCSV（）方法中，我们还要实现邮件发送逻辑，而这些，都是通过spring提供的mail封装来完成的，同时，因为日方提供了邮件模板，要根据模板设置邮件内容，所以我又引入了velocity，而spring对其也同样有所支持，呵呵，到此看来，这些东西真的是结合的天衣无缝了。</p>
<p>对于数据邮件的发送部分，偶在这里就不作详述了，不过大家如果有兴趣的话，可以参考Matt Raible的一篇blog《Sending Velocity－based Email with Spring》，上面对整个流程阐述的很明了，另外，读一下spring的javadoc也挺好，对于邮件发送部分，spring只是提供了几个包装类，很容易就可以搞清楚各个类的左右和他们之间的关系，而这对于你以后应用spring来说更会得心应手。</p>
<p>最后，我们不妨用一个UML的class图来阐明这个简单的框架实现吧 - [img]http://images.blogcn.com/2005/2/25/12/darrenwang,2005022523923.jpg[/img]</p>
                
                <!--百度分享按钮-->
                <div class="pull-left bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a></div>
                <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

                <!--二维码分享-->
                <div id="wx_qr"></div>
                <script type="text/javascript">
                  var baseUrl = "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data="
                  var qrUrl = baseUrl.concat(document.URL)
                  var img = document.createElement("img")
                  img.setAttribute("src", qrUrl)

                  document.getElementById("wx_qr").appendChild(img)
                </script>


                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'afoo'; // required: replace example with your forum shortname

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

              </div>
              </div>
              </div>
            </div>
            <div class="row">
                <div class="col-md-12 footer">
                  <hr>
                  <p>©FuqiangWang@<a href="http://keevol.com">keevol.com</a></p>
                  <p>Powered by <a href="http://johnmacfarlane.net/pandoc/">pandoc</a>, <a href="http://rometools.github.io/rome/index.html">ROME</a> and <a href="http://pages.github.com/">github pages</a></p>
                </div>
            </div>
        </div>
      </div>
    </div>

    <script src="/js/jquery-2.1.1.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1000502179'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1000502179%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
  </body>

</html>
